@page "/tickets"
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<PageTitle>Tickets</PageTitle>

<h1>Tickets</h1>

<p>View and manage all support tickets.</p>

<div class="card mb-4">
    <div class="card-header">
        <h4>Create New Ticket</h4>
    </div>
    <div class="card-body">
        <form @onsubmit="CreateTicket">
            <div class="mb-3">
                <label for="title" class="form-label">Title:</label>
                <input type="text" class="form-control" id="title" @bind="newTicket.Title" required />
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description:</label>
                <textarea class="form-control" id="description" rows="4" @bind="newTicket.Description" required></textarea>
            </div>

            <div class="mb-3">
                <label for="creatorUserId" class="form-label">Creator User:</label>
                @if (users == null)
                {
                    <p><em>Loading users...</em></p>
                }
                else if (users.Count == 0)
                {
                    <p><em>No users available. Please create a user first.</em></p>
                }
                else
                {
                    <select class="form-control" id="creatorUserId" @bind="newTicket.CreatorUserId" required>
                        <option value="0">-- Select a user --</option>
                        @foreach (var user in users)
                        {
                            <option value="@user.Id">@user.Username</option>
                        }
                    </select>
                }
            </div>

            <div class="mb-3">
                <label for="statusId" class="form-label">Status:</label>
                <select class="form-control" id="statusId" @bind="newTicket.StatusId" required>
                    <option value="0">-- Select a status --</option>
                    @foreach (var status in statuses)
                    {
                        <option value="@status.Key">@status.Value</option>
                    }
                </select>
            </div>

            <button type="submit" class="btn btn-primary">Create Ticket</button>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-danger mt-3" role="alert">
                    @errorMessage
                </div>
            }
            @if (!string.IsNullOrEmpty(successMessage))
            {
                <div class="alert alert-success mt-3" role="alert">
                    @successMessage
                </div>
            }
        </form>
    </div>
</div>

@if (tickets == null)
{
    <p><em>Loading tickets...</em></p>
}
else if (tickets.Count == 0)
{
    <p><em>No tickets found.</em></p>
}
else
{
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Description</th>
                <th>Created By</th>
                <th>Status</th>
                <th>Date Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var ticket in tickets)
            {
                <tr>
                    <td>@ticket.Id</td>
                    <td>@ticket.Title</td>
                    <td>@ticket.Description</td>
                    <td>@ticket.CreatorUser?.Username</td>
                    <td>
                        <select class="form-select form-select-sm" @onchange="async (ChangeEventArgs e) => await UpdateTicketStatus(ticket.Id, int.Parse((string)e.Value!))">
                            <option value="0">-- Select --</option>
                            @foreach (var status in statuses)
                            {
                                <option value="@status.Key" selected="@(ticket.StatusId == status.Key)">@status.Value</option>
                            }
                        </select>
                    </td>
                    <td>@ticket.DateCreated.ToShortDateString()</td>
                    <td>
                        <button class="btn btn-danger btn-sm" @onclick="async () => await DeleteTicket(ticket.Id)">Delete</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<Ticket>? tickets;
    private List<User>? users;
    private Dictionary<int, string> statuses = new();
    private Ticket newTicket = new();
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        statuses = new Dictionary<int, string>
        {
            { 1, "Working On" },
            { 2, "Ready To Be Picked Up" },
            { 3, "Finished" }
        };

        await LoadTickets();
        await LoadUsers();
    }

    private async Task LoadTickets()
    {
        try
        {
            tickets = await Http.GetFromJsonAsync<List<Ticket>>("api/tickets") ?? new List<Ticket>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading tickets: {ex.Message}");
            tickets = new List<Ticket>();
            errorMessage = "Failed to load tickets.";
        }
    }

    private async Task LoadUsers()
    {
        try
        {
            users = await Http.GetFromJsonAsync<List<User>>("api/users") ?? new List<User>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading users: {ex.Message}");
            users = new List<User>();
        }
    }

    private async Task CreateTicket()
    {
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            newTicket.DateCreated = DateTime.Now;

            var response = await Http.PostAsJsonAsync("api/tickets", newTicket);

            if (response.IsSuccessStatusCode)
            {
                successMessage = "Ticket created successfully!";
                newTicket = new();
                await LoadTickets();
            }
            else
            {
                var content = await response.Content.ReadAsStringAsync();
                errorMessage = $"Failed to create ticket. Status: {response.StatusCode} - {content}";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error creating ticket: {ex.Message}");
            errorMessage = $"Error creating ticket: {ex.Message}";
        }
    }

    private async Task UpdateTicketStatus(int ticketId, int newStatusId)
    {
        if (newStatusId <= 0 || tickets == null)
            return;

        try
        {
            var ticket = tickets.FirstOrDefault(t => t.Id == ticketId);
            if (ticket == null)
                return;

            ticket.StatusId = newStatusId;

            var response = await Http.PutAsJsonAsync($"api/tickets/{ticketId}", ticket);

            if (!response.IsSuccessStatusCode)
            {
                errorMessage = "Failed to update ticket status";
                await LoadTickets();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating ticket status: {ex.Message}");
            errorMessage = $"Error updating ticket status: {ex.Message}";
        }
    }

    private async Task DeleteTicket(int ticketId)
    {
        if (!await ConfirmDelete())
            return;

        try
        {
            var response = await Http.DeleteAsync($"api/tickets/{ticketId}");

            if (response.IsSuccessStatusCode)
            {
                successMessage = "Ticket deleted successfully!";
                await LoadTickets();
            }
            else
            {
                errorMessage = "Failed to delete ticket";
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting ticket: {ex.Message}");
            errorMessage = $"Error deleting ticket: {ex.Message}";
        }
    }

    private async Task<bool> ConfirmDelete()
    {
        return await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this ticket?");
    }

    public class Ticket
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public DateTime DateCreated { get; set; }

        public int CreatorUserId { get; set; }
        public User? CreatorUser { get; set; }

        public int StatusId { get; set; }
        public TicketStatus? Status { get; set; }
    }

    public class User
    {
        public int Id { get; set; }
        public string Username { get; set; } = string.Empty;
        public string Role { get; set; } = string.Empty;
    }

    public class TicketStatus
    {
        public int Id { get; set; }
        public string StatusName { get; set; } = string.Empty;
    }
}
